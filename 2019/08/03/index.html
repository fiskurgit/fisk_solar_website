<!--- dither=atkinson,maxwidth=500 -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Off-cloud Webserver Part 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">
    <style>
    body{
        background: #fff;
        max-width: 960px;
        color: black;
        padding: 12px;
        line-height: 1.8;
        font-family: 'Helvetica', 'Arial', sans-serif;
        font-size: 12pt;
        font-weight: 400;
        display: block;
    }
    code{
      background: #f8f8f8;
    }
    pre{
      background: #f8f8f8;
      line-height: 1.5;
      font-size: 16px;
      font-family: monospace;
    }
    p.poster{
      max-width: 100%;
    }
    hr{
        border: 1px solid black;
    }
    img{
        max-width: 100%;
        min-width: 100%;
    }
    footer{
        font-size: 0.95rem;
        text-align: left;
    }
    a{
        color: black;
        text-decoration: underline;
    }
    a:hover{
        color: rgb(80, 56, 0);
        text-decoration: underline;
    }
    h1{
        font-size: 2.0rem;
        text-transform: uppercase;
        padding-bottom: 30px;
    }
    .grid-container {
        display: grid;
        grid-template-columns: auto auto auto;
        padding: 10px;
    }
    .grid-item {
        padding: 20px;
        font-size: 30px;
        text-align: justify;
    }
</style>
</head>

<body style="background-color:#e9f1e8" onload="fetchSourhallData()">
<header></header>
<div class="content">
    <!--- -bg #e9f1e8 -->
<h1>Off-cloud Webserver Part 2</h1><h4>03rd August 2019</h4><p><strong>The previous post covered relatively simple port-forwarding steps on a router to self-host a website. I've now escaped Sky Broadband and switched to 4GEE cellular broadband which offers higher bandwidth in our rural location. EE 4G broadband operates <a href="https://en.wikipedia.org/wiki/Carrier-grade_NAT">Carrier Grade NAT</a> which means a simple port forward from the router won't work. Here I'm detailing how I kept <a href="http://fisksolar.ddns.net/">Fisk Solar</a> online.</strong></p><ul><li>Unfortunately I can't think of any easy way of hosting a website on this 4G connection without having to rely on some kind of tunnel to a hosted service. A VPN service that supports a static Ip address and port forwarding should be fine, but they're also quite expensive. Instead I've got a <a href="https://en.wikipedia.org/wiki/Virtual_private_server">Virtual Private Server</a> from <a href="https://www.fasthosts.co.uk/virtual-private-servers">Fast Hosts</a> which is currently £2.49 a month. <em>This solution does mean my off-cloud website is now not fully off-cloud.</em></li><li>From the VPS web-based control panel I setup a firewall rule to allow web traffic on port 80, and ssh access on the standard 443.</li><li>From a terminal I then ssh to the VPS and configure the ssh server config to allow reverse ssh tunneling: <code>nano /etc/ssh/sshd_config</code> the main setting being: <code>GatewayPorts yes</code></li><li>Once this config file has been saved restart ssh to load the rule changes:<pre><code>service sshd restart
</code></pre></li><li>I then exited the VPS ssh session and ssh to my Pi Zero, from there create a reverse ssh tunnel from the VPS, any traffic hitting port 80 of the remote VPS will be forwarded to port 80 of my local Pi Zero (see Addendum below for update on this):<pre><code>ssh -R 80:localhost:80 user@77.68.25.88
</code></pre></li><li>The last step is to change the <a href="https://www.noip.com/">No-ip</a> domain to reference the VPS Ip address: http://fisksolar.ddns.net is now up and running again.</li></ul><h2>Addendum</h2><p>If one side of the ssh connection fails things get into a hung state where simply setting up the tunnel again will fail which was only solved by restarting the VPS. After some research I found the following arguments which hopefully will stay alive more reliably and also safely close the session and allow a cron job on the Pi Zero to get it up and running again:</p><pre><code>ssh -f -N -R 80:192.168.86.28:80 user@77.68.25.88 -o ExitOnForwardFailure=yes  -o ServerAliveInterval=60 -o ServerAliveCountMax=10
</code></pre><h3>Todo</h3><ul><li>Set up passwordless ssh between Pi Zero and VPS</li><li>Cron job on the Pi Zero to retry connection</li></ul>
</div>

<footer>
<hr>
    Inspired by <a href="https://solar.lowtechmagazine.com">LOW←TECH MAGAZINE</a> | Page size including images: 4.8kb | <a href="https://github.com/fiskurgit/Statisk">Fisk Statisk</a><br>
</footer>
</body>
</html>
